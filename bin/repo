#!/bin/sh
# commands used:
# - git
# - mktemp
# - repo-add
# - repo-remove
# - scp

init_variables() {
  COMMAND=${0##*/}

  TMP_DIR="$( TMPDIR='/var/tmp' mktemp -d )"
  trap 'rm -rf "${TMP_DIR}"' EXIT

  AUR_URL='https://aur.archlinux.org'
  SRV_DIR='/srv/http'

  REPO=
  ACTION=
  PACKAGE=
  PACKAGES=
  TOOL_OPTIONS=
}

show_usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>] <repo> add <package_file> [<package_file>...] [-- <tool options>...]
	       ${COMMAND} [<options>] <repo> remove <package_name> [<package_name>...] [-- <tool options>...]
	       ${COMMAND} [<options>] <repo> sync <package_name> [-- <tool options>...]

	Manage personal remote repository packages

	Options:
	  -h    show this message only
	EOF
}

parse_command_line() {
  while getopts h OPT; do
    case "${OPT}" in
      h) show_usage; exit 0 ;;
      ?) exit_error ;;
    esac
  done

  shift $(( OPTIND - 1 ))

  REPO="$1"
  ACTION="$2"

  [ $# -lt 2 ] && return
  shift 2

  while [ "$#" -gt 0 ] && [ "$1" != '--' ]; do
    if [ "${ACTION}" = 'sync' ]; then
      PACKAGE="$1"
    else
      PACKAGES="${PACKAGES} $1"
    fi
    shift
  done

  if [ "$1" = '--' ]; then
    shift
    TOOL_OPTIONS="$*"
  fi
}

validate_command_line() {
  if [ -z "${REPO}" ]; then
    exit_error 'missing repo operand'
  fi

  if [ "${REPO}" != 'aur' ] \
    && [ "${REPO}" != 'tardypad' ]; then
    exit_error "invalid repo '${REPO}'"
  fi

  if [ -z "${ACTION}" ]; then
    exit_error 'missing action operand'
  fi

  if [ "${ACTION}" != 'add' ] \
    && [ "${ACTION}" != 'remove' ] \
    && [ "${ACTION}" != 'sync' ]; then
    exit_error "invalid action '${ACTION}'"
  fi

  if [ "${ACTION}" = 'sync' ]; then
    if [ -z "${PACKAGE}" ]; then
      exit_error 'missing package operand'
    fi
  else
    if [ -z "${PACKAGES}" ]; then
      exit_error 'missing package operands'
    fi
  fi
}

exit_error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  exit 1
} >&2

import_env() {
  scp -q "chestnut:/${SRV_DIR}/pkgs/arch/${REPO}/${REPO}.files.tar.xz" "${TMP_DIR}"
  scp -q "chestnut:/${SRV_DIR}/pkgs/arch/${REPO}/${REPO}.db.tar.xz" "${TMP_DIR}"
  ln -s "${TMP_DIR}/${REPO}.files.tar.xz" "${TMP_DIR}/${REPO}.files"
  ln -s "${TMP_DIR}/${REPO}.db.tar.xz" "${TMP_DIR}/${REPO}.db"
}

export_env() {
  scp -q "${TMP_DIR}"/*.tar.zst "chestnut:/${SRV_DIR}/pkgs/arch/${REPO}/" 2> /dev/null

  if [ "${ACTION}" = 'add' ]; then
    scp -q ${PACKAGES} "chestnut:/${SRV_DIR}/pkgs/arch/${REPO}/"
  fi

  scp -q "${TMP_DIR}"/*.tar.xz "chestnut:/${SRV_DIR}/pkgs/arch/${REPO}/"
}

add_package() {
  repo-add ${TOOL_OPTIONS} "${TMP_DIR}/${REPO}.db.tar.xz" ${PACKAGES}
}

remove_package() {
  repo-remove ${TOOL_OPTIONS} "${TMP_DIR}/${REPO}.db.tar.xz" ${PACKAGES}
}

sync_package() (
    cd "${TMP_DIR}" || exit
    git clone -q "${AUR_URL}/${PACKAGE}" "${PACKAGE}"
    printf '%s %s\n' 'Review the package' "${TMP_DIR}/${PACKAGE}/PKGBUILD"
    printf '%s\n' 'Press Return to continue, Ctrl-c to abort'
    read -r

    cd "${PACKAGE}" || exit
    PKGDEST="${TMP_DIR}" makepkg --noconfirm --syncdeps --rmdeps --clean ${TOOL_OPTIONS}
    repo-add ../"${REPO}.db.tar.xz" ../"${PACKAGE}"*.tar.zst
)

init_variables
parse_command_line "$@"
validate_command_line

import_env \
&& "${ACTION}_package" \
&& export_env
